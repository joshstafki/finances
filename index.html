<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Finance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Tailwind gray-100 */
        }
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* Tailwind slate-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* Tailwind slate-500 */
        }
        /* Style for D3 chart tooltips */
        .d3-tooltip {
            position: absolute;
            text-align: center;
            padding: 8px;
            font-size: 12px;
            background: #334155; /* Tailwind slate-700 */
            color: white;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        /* Ensure select dropdowns have consistent styling */
        select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem; /* Make space for arrow */
        }
        /* Modal styles */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-active {
            overflow-x: hidden;
            overflow-y: auto;
        }
    </style>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 md:p-6 lg:p-8 max-w-7xl">

        <header class="mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-700 text-center">Advanced Finance Tracker</h1>
        </header>

        <section id="dashboardSummary" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 md:gap-6 mb-8">
            <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg">
                <h3 class="text-sm font-medium text-slate-500">Total Income</h3>
                <p id="totalIncomeDisplay" class="text-2xl font-semibold text-green-600 mt-1">$0.00</p>
            </div>
            <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg">
                <h3 class="text-sm font-medium text-slate-500">Total Expenses</h3>
                <p id="totalExpensesDisplay" class="text-2xl font-semibold text-red-600 mt-1">$0.00</p>
            </div>
            <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg">
                <h3 class="text-sm font-medium text-slate-500">Net Balance</h3>
                <p id="netBalanceDisplay" class="text-2xl font-semibold text-blue-600 mt-1">$0.00</p>
            </div>
            <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg">
                <h3 class="text-sm font-medium text-slate-500">Spendable Target</h3>
                <div class="flex items-center">
                    <input type="number" id="spendableIncomeTargetInput" class="text-2xl font-semibold text-purple-600 mt-1 w-full bg-transparent border-b border-purple-200 focus:outline-none focus:border-purple-500" value="1534.00">
                </div>
            </div>
            <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg">
                <h3 class="text-sm font-medium text-slate-500">% Target Used</h3>
                <p id="percentageTargetUsedDisplay" class="text-2xl font-semibold text-orange-500 mt-1">0%</p>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6 mb-8">
            <div class="lg:col-span-2 bg-white p-4 md:p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-4 text-slate-700">Expense Breakdown</h2>
                <div id="expenseChartContainer" class="w-full h-64 md:h-80">
                    <svg id="expenseChart"></svg>
                </div>
                <p id="noExpenseDataMessage" class="text-center text-slate-500 hidden">No expense data to display chart.</p>
            </div>

            <div class="lg:col-span-1 bg-white p-4 md:p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-4 text-slate-700" id="formTitle">Add New Transaction</h2>
                <form id="transactionForm" class="space-y-4">
                    <input type="hidden" id="transactionId">
                    <div>
                        <label for="transactionType" class="block text-sm font-medium text-slate-600">Type</label>
                        <select id="transactionType" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="expense">Expense</option>
                            <option value="income">Income</option>
                        </select>
                    </div>
                    <div>
                        <label for="description" class="block text-sm font-medium text-slate-600">Description</label>
                        <input type="text" id="description" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., Groceries, Salary">
                    </div>
                    <div>
                        <label for="amount" class="block text-sm font-medium text-slate-600">Amount</label>
                        <input type="number" id="amount" step="0.01" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="0.00">
                    </div>
                    <div>
                        <label for="category" class="block text-sm font-medium text-slate-600">Category</label>
                        <select id="category" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </select>
                    </div>
                    <div>
                        <label for="transactionDate" class="block text-sm font-medium text-slate-600">Date</label>
                        <input type="date" id="transactionDate" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div id="dueDateGroup">
                        <label for="dueDate" class="block text-sm font-medium text-slate-600">Due Date (Optional)</label>
                        <input type="date" id="dueDate" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div id="statusGroup">
                        <label for="status" class="block text-sm font-medium text-slate-600">Status</label>
                        <select id="status" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="Unpaid">Unpaid</option>
                            <option value="Paid">Paid</option>
                            <option value="Pending">Pending</option>
                        </select>
                    </div>
                     <div id="paymentSourceGroup">
                        <label for="paymentSource" class="block text-sm font-medium text-slate-600">Payment Source</label>
                        <select id="paymentSource" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                             </select>
                    </div>
                    <div>
                        <label for="notes" class="block text-sm font-medium text-slate-600">Notes (Optional)</label>
                        <textarea id="notes" rows="2" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Any additional details..."></textarea>
                    </div>
                    <div class="flex space-x-2">
                        <button type="submit" id="saveTransactionBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                            Save Transaction
                        </button>
                        <button type="button" id="cancelEditBtn" class="w-full bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-2 px-4 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400 transition duration-150 ease-in-out hidden">
                            Cancel Edit
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="messageArea" class="mb-4 text-center"></div>

        <section class="bg-white p-4 md:p-6 rounded-xl shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-slate-700">Transaction History</h2>
            <div class="mb-4 flex flex-col sm:flex-row gap-4">
                <div class="flex-1">
                    <label for="filterType" class="block text-sm font-medium text-slate-600">Filter by Type:</label>
                    <select id="filterType" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="all">All Transactions</option>
                        <option value="expense">Expenses Only</option>
                        <option value="income">Income Only</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label for="filterCategory" class="block text-sm font-medium text-slate-600">Filter by Category:</label>
                    <select id="filterCategory" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="all">All Categories</option>
                        </select>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Date</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Description</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Category</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Amount</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Type</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Status/Source</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactionTableBody" class="bg-white divide-y divide-slate-200">
                        </tbody>
                </table>
            </div>
            <p id="noTransactionsMessage" class="text-center text-slate-500 py-8">No transactions yet. Add one above!</p>
        </section>

        <footer class="mt-8 text-center text-sm text-slate-500">
            <p>&copy; <span id="currentYear"></span> Finance Tracker. Manage your finances with ease.</p>
            </footer>

    </div> <script>
        // --- DATA STORE & INITIALIZATION ---
        let appData = {
            transactions: [],
            categories: {
                expense: ['Health/Wellness', 'Subscriptions', 'Food', 'Transportation', 'Utilities', 'Housing', 'Savings Transfer', 'Insurance', 'Credit Card Pmt', 'Miscellaneous'],
                income: ['Salary', 'Freelance', 'Investment', 'Gift', 'Other']
            },
            paymentSources: ['US Bank', 'Wells Fargo', 'Cash', 'Credit Card A', 'Other'],
            settings: {
                spendableIncomeTarget: 1534.00,
                currencySymbol: '$'
            },
            editingTransactionId: null
        };

        const initialTransactions = [
            { id: 'tx_op1', type: 'expense', description: 'Planet Fitness', amount: 26.97, category: 'Health/Wellness', date: '', dueDate: '', status: 'Unpaid', paymentSource: 'US Bank', notes: '' },
            { id: 'tx_op2', type: 'expense', description: 'Spotify', amount: 6.93, category: 'Subscriptions', date: '', dueDate: '', status: 'Unpaid', paymentSource: 'US Bank', notes: '' },
            { id: 'tx_op3', type: 'expense', description: 'Amazon Prime', amount: 8.90, category: 'Subscriptions', date: '', dueDate: '', status: 'Unpaid', paymentSource: 'US Bank', notes: '' },
            { id: 'tx_bi1', type: 'expense', description: 'Groceries', amount: 140.00, category: 'Food', date: '', dueDate: '2025-04-21', status: 'Unpaid', paymentSource: 'Wells Fargo', notes: '' },
            { id: 'tx_bi2', type: 'expense', description: 'Gas', amount: 140.00, category: 'Transportation', date: '', dueDate: '', status: 'Unpaid', paymentSource: 'Wells Fargo', notes: '' },
            { id: 'tx_bi3', type: 'expense', description: 'T Mobile', amount: 53.00, category: 'Utilities', date: '', dueDate: '', status: 'Unpaid', paymentSource: 'Wells Fargo', notes: '' },
            { id: 'tx_bi4', type: 'expense', description: 'Rent', amount: 200.00, category: 'Housing', date: '', dueDate: '', status: 'Unpaid', paymentSource: 'Wells Fargo', notes: '' },
            { id: 'tx_bi5', type: 'expense', description: 'Savings', amount: 49.99, category: 'Savings Transfer', date: '', dueDate: '', status: 'Unpaid', paymentSource: 'Wells Fargo', notes: '' },
            { id: 'tx_bi6', type: 'expense', description: 'Insurance', amount: 150.00, category: 'Insurance', date: '', dueDate: '', status: 'Unpaid', paymentSource: 'Wells Fargo', notes: '' },
            { id: 'tx_bi7', type: 'expense', description: 'Rent II', amount: 400.00, category: 'Housing', date: '', dueDate: '', status: 'Unpaid', paymentSource: 'Wells Fargo', notes: '' },
            { id: 'tx_bi8', type: 'expense', description: 'Citi Statement', amount: 58.21, category: 'Credit Card Pmt', date: '', dueDate: '', status: 'Unpaid', paymentSource: 'Wells Fargo', notes: '' },
            { id: 'tx_inc1', type: 'income', description: 'Salary/Job', amount: 300.00, category: 'Salary', date: '2025-05-16', dueDate: '', status: 'Received', paymentSource: '', notes: 'Pay Period: 4/21/2025 - 5/4/2025' }
        ];
        
        // --- DOM ELEMENTS ---
        const transactionForm = document.getElementById('transactionForm');
        const transactionTypeSelect = document.getElementById('transactionType');
        const categorySelect = document.getElementById('category');
        const paymentSourceSelect = document.getElementById('paymentSource');
        const dueDateGroup = document.getElementById('dueDateGroup');
        const statusGroup = document.getElementById('statusGroup');
        const paymentSourceGroup = document.getElementById('paymentSourceGroup');
        const transactionTableBody = document.getElementById('transactionTableBody');
        const totalIncomeDisplay = document.getElementById('totalIncomeDisplay');
        const totalExpensesDisplay = document.getElementById('totalExpensesDisplay');
        const netBalanceDisplay = document.getElementById('netBalanceDisplay');
        const spendableIncomeTargetInput = document.getElementById('spendableIncomeTargetInput');
        const percentageTargetUsedDisplay = document.getElementById('percentageTargetUsedDisplay');
        const formTitle = document.getElementById('formTitle');
        const saveTransactionBtn = document.getElementById('saveTransactionBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const transactionIdInput = document.getElementById('transactionId');
        const messageArea = document.getElementById('messageArea');
        const filterTypeSelect = document.getElementById('filterType');
        const filterCategorySelect = document.getElementById('filterCategory');
        const noTransactionsMessage = document.getElementById('noTransactionsMessage');
        const noExpenseDataMessage = document.getElementById('noExpenseDataMessage');


        // --- UTILITY FUNCTIONS ---
        const generateId = () => '_' + Math.random().toString(36).substr(2, 9);
        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            // Handles YYYY-MM-DD and also potentially MM/DD/YYYY if needed, but standardizing to YYYY-MM-DD from input type=date
            const date = new Date(dateString + 'T00:00:00'); // Ensure correct parsing regardless of timezone
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        };
        const formatCurrency = (amount) => {
            const sym = appData.settings.currencySymbol || '$';
            return `${sym}${parseFloat(amount).toFixed(2)}`;
        };

        function showMessage(message, type = 'success', duration = 3000) {
            messageArea.innerHTML = `<div class="p-3 rounded-md text-sm ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${message}</div>`;
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, duration);
        }

        // --- LOCAL STORAGE ---
        function saveData() {
            localStorage.setItem('financeAppData', JSON.stringify(appData));
        }

        function loadData() {
            const storedData = localStorage.getItem('financeAppData');
            if (storedData) {
                appData = JSON.parse(storedData);
            } else {
                // First time load: use initial transactions if transactions array is empty
                if (appData.transactions.length === 0) {
                     appData.transactions = initialTransactions.map(t => ({...t, id: t.id || generateId() }));
                }
            }
             // Ensure settings object and spendableIncomeTarget exist
            if (!appData.settings) appData.settings = { spendableIncomeTarget: 1534.00, currencySymbol: '$' };
            if (typeof appData.settings.spendableIncomeTarget === 'undefined') appData.settings.spendableIncomeTarget = 1534.00;
            if (typeof appData.settings.currencySymbol === 'undefined') appData.settings.currencySymbol = '$';

            spendableIncomeTargetInput.value = appData.settings.spendableIncomeTarget.toFixed(2);
        }

        // --- UI UPDATES & RENDERING ---
        function populateCategories() {
            const type = transactionTypeSelect.value;
            const categories = appData.categories[type] || [];
            categorySelect.innerHTML = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            // Add "Add New Category" option if desired
            // categorySelect.innerHTML += `<option value="add_new_category">-- Add New --</option>`;
            
            // Populate filter category dropdown
            const allCategories = [...new Set([...appData.categories.expense, ...appData.categories.income])].sort();
            filterCategorySelect.innerHTML = '<option value="all">All Categories</option>';
            filterCategorySelect.innerHTML += allCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }
        
        function populatePaymentSources() {
            paymentSourceSelect.innerHTML = appData.paymentSources.map(src => `<option value="${src}">${src}</option>`).join('');
            // Add "Add New Source" option if desired
            // paymentSourceSelect.innerHTML += `<option value="add_new_source">-- Add New --</option>`;
        }

        function toggleFormFields() {
            const type = transactionTypeSelect.value;
            if (type === 'income') {
                dueDateGroup.classList.add('hidden');
                statusGroup.classList.add('hidden');
                paymentSourceGroup.classList.add('hidden');
            } else { // expense
                dueDateGroup.classList.remove('hidden');
                statusGroup.classList.remove('hidden');
                paymentSourceGroup.classList.remove('hidden');
            }
            populateCategories(); // Repopulate based on type
        }

        function renderTransactions() {
            transactionTableBody.innerHTML = ''; // Clear existing rows
            
            const typeFilter = filterTypeSelect.value;
            const categoryFilter = filterCategorySelect.value;

            const filteredTransactions = appData.transactions.filter(t => {
                const typeMatch = typeFilter === 'all' || t.type === typeFilter;
                const categoryMatch = categoryFilter === 'all' || t.category === categoryFilter;
                return typeMatch && categoryMatch;
            }).sort((a,b) => new Date(b.date || 0) - new Date(a.date || 0)); // Sort by date, newest first


            if (filteredTransactions.length === 0) {
                transactionTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-slate-500 py-8">No transactions match your filters.</td></tr>`;
                noTransactionsMessage.classList.add('hidden'); // Hide the general "no transactions" message if filters result in none
            } else {
                 noTransactionsMessage.classList.add('hidden'); // Hide if there are transactions
            }
            
            if (appData.transactions.length === 0) {
                noTransactionsMessage.classList.remove('hidden');
            }


            filteredTransactions.forEach(t => {
                const row = transactionTableBody.insertRow();
                row.className = `hover:bg-slate-50 ${t.type === 'income' ? 'text-green-700' : 'text-red-700'}`;
                
                const statusOrSourceText = t.type === 'expense' ? `${t.status} (${t.paymentSource || 'N/A'})` : (t.category || 'N/A');
                const statusColorClass = t.type === 'expense' ? (t.status === 'Paid' ? 'bg-green-100 text-green-800' : (t.status === 'Unpaid' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800')) : 'bg-blue-100 text-blue-800';


                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm">${formatDate(t.date)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">${t.description}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">${t.category}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold">${formatCurrency(t.amount)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${t.type === 'income' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${t.type.charAt(0).toUpperCase() + t.type.slice(1)}
                        </span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                         <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColorClass}">
                            ${t.type === 'expense' ? t.status : 'Received'}
                        </span>
                        ${t.type === 'expense' && t.paymentSource ? `<span class="text-xs text-slate-500 ml-1">(${t.paymentSource})</span>` : ''}
                         ${t.type === 'expense' && t.dueDate ? `<br><span class="text-xs text-slate-400">Due: ${formatDate(t.dueDate)}</span>` : ''}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="startEditTransaction('${t.id}')" class="text-blue-600 hover:text-blue-800 p-1" title="Edit">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        </button>
                        <button onclick="deleteTransaction('${t.id}')" class="text-red-600 hover:text-red-800 p-1 ml-2" title="Delete">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                    </td>
                `;
            });
            updateSummary();
            renderExpenseChart();
        }

        function updateSummary() {
            const income = appData.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const expenses = appData.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const net = income - expenses;

            totalIncomeDisplay.textContent = formatCurrency(income);
            totalExpensesDisplay.textContent = formatCurrency(expenses);
            netBalanceDisplay.textContent = formatCurrency(net);
            netBalanceDisplay.className = `text-2xl font-semibold mt-1 ${net >= 0 ? 'text-blue-600' : 'text-red-600'}`;


            const target = parseFloat(appData.settings.spendableIncomeTarget) || 0;
            const percentageUsed = target > 0 ? (expenses / target) * 100 : 0;
            percentageTargetUsedDisplay.textContent = `${percentageUsed.toFixed(1)}%`;
        }
        
        // --- D3 CHART ---
        function renderExpenseChart() {
            const chartSvg = d3.select("#expenseChart");
            chartSvg.selectAll("*").remove(); // Clear previous chart

            const expenseData = appData.transactions.filter(t => t.type === 'expense');
            if (expenseData.length === 0) {
                noExpenseDataMessage.classList.remove('hidden');
                d3.select("#expenseChartContainer").style("height", "auto"); // collapse container
                return;
            }
            noExpenseDataMessage.classList.add('hidden');
            d3.select("#expenseChartContainer").style("height", null); // restore container height


            const expensesByCategory = d3.rollup(expenseData, 
                v => d3.sum(v, leaf => leaf.amount), 
                d => d.category
            );

            const dataForChart = Array.from(expensesByCategory, ([key, value]) => ({ category: key, amount: value }))
                                    .sort((a,b) => b.amount - a.amount); // Sort descending

            const container = document.getElementById('expenseChartContainer');
            const margin = {top: 20, right: 20, bottom: 70, left: 60}; // Increased bottom for labels
            const width = container.clientWidth - margin.left - margin.right;
            const height = container.clientHeight - margin.top - margin.bottom;
            
            if (width <=0 || height <=0) return; // Don't render if no space

            const svg = chartSvg
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
              .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .range([0, width])
                .domain(dataForChart.map(d => d.category))
                .padding(0.3);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                  .attr("transform", "translate(-10,0)rotate(-45)")
                  .style("text-anchor", "end")
                  .style("font-size", "10px");

            const yMax = d3.max(dataForChart, d => d.amount);
            const y = d3.scaleLinear()
                .domain([0, yMax > 0 ? yMax : 100]) // Ensure domain is at least 0-100
                .range([height, 0]);

            svg.append("g")
                .call(d3.axisLeft(y).ticks(5).tickFormat(d => formatCurrency(d).replace(appData.settings.currencySymbol, '')))
                .selectAll("text")
                  .style("font-size", "10px");
            
            // Tooltip
            const tooltip = d3.select("body").append("div")
                .attr("class", "d3-tooltip");

            svg.selectAll("mybar")
                .data(dataForChart)
                .join("rect")
                  .attr("x", d => x(d.category))
                  .attr("y", d => y(d.amount))
                  .attr("width", x.bandwidth())
                  .attr("height", d => height - y(d.amount))
                  .attr("fill", "#60a5fa") // Tailwind blue-400
                  .on("mouseover", (event, d) => {
                      tooltip.transition().duration(200).style("opacity", .9);
                      tooltip.html(`<strong>${d.category}</strong><br>${formatCurrency(d.amount)}`)
                          .style("left", (event.pageX + 5) + "px")
                          .style("top", (event.pageY - 28) + "px");
                  })
                  .on("mouseout", () => {
                      tooltip.transition().duration(500).style("opacity", 0);
                  });
        }


        // --- EVENT HANDLERS & LOGIC ---
        transactionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const id = transactionIdInput.value || generateId();
            const type = transactionTypeSelect.value;
            const description = document.getElementById('description').value.trim();
            const amount = parseFloat(document.getElementById('amount').value);
            const category = categorySelect.value;
            const date = document.getElementById('transactionDate').value;
            
            // Validate inputs
            if (!description || isNaN(amount) || amount <= 0 || !category || !date) {
                showMessage('Please fill in all required fields with valid data.', 'error');
                return;
            }

            const transaction = {
                id, type, description, amount, category, date,
                dueDate: type === 'expense' ? document.getElementById('dueDate').value : '',
                status: type === 'expense' ? document.getElementById('status').value : 'Received',
                paymentSource: type === 'expense' ? paymentSourceSelect.value : '',
                notes: document.getElementById('notes').value.trim()
            };

            if (appData.editingTransactionId) {
                const index = appData.transactions.findIndex(t => t.id === appData.editingTransactionId);
                appData.transactions[index] = transaction;
                appData.editingTransactionId = null;
                showMessage('Transaction updated successfully!', 'success');
            } else {
                appData.transactions.push(transaction);
                showMessage('Transaction added successfully!', 'success');
            }
            
            resetForm();
            saveData();
            renderTransactions();
        });

        function resetForm() {
            transactionForm.reset();
            transactionIdInput.value = '';
            appData.editingTransactionId = null;
            formTitle.textContent = 'Add New Transaction';
            saveTransactionBtn.textContent = 'Save Transaction';
            cancelEditBtn.classList.add('hidden');
            document.getElementById('transactionDate').valueAsDate = new Date(); // Default to today
            toggleFormFields(); // Reset field visibility
        }
        
        cancelEditBtn.addEventListener('click', resetForm);

        window.startEditTransaction = function(id) { // Make it global for inline onclick
            const transaction = appData.transactions.find(t => t.id === id);
            if (!transaction) return;

            appData.editingTransactionId = id;
            transactionIdInput.value = id;
            transactionTypeSelect.value = transaction.type;
            toggleFormFields(); // Update form fields based on type first
            
            document.getElementById('description').value = transaction.description;
            document.getElementById('amount').value = transaction.amount;
            categorySelect.value = transaction.category; // Ensure category exists for this type
            document.getElementById('transactionDate').value = transaction.date;
            document.getElementById('notes').value = transaction.notes;

            if (transaction.type === 'expense') {
                document.getElementById('dueDate').value = transaction.dueDate;
                document.getElementById('status').value = transaction.status;
                paymentSourceSelect.value = transaction.paymentSource;
            }
            
            formTitle.textContent = 'Edit Transaction';
            saveTransactionBtn.textContent = 'Update Transaction';
            cancelEditBtn.classList.remove('hidden');
            document.getElementById('description').focus(); // Focus on first field
            window.scrollTo({ top: transactionForm.offsetTop - 20, behavior: 'smooth' });
        }

        window.deleteTransaction = function(id) { // Make it global
            if (confirm('Are you sure you want to delete this transaction?')) {
                appData.transactions = appData.transactions.filter(t => t.id !== id);
                saveData();
                renderTransactions();
                showMessage('Transaction deleted.', 'success');
            }
        }
        
        transactionTypeSelect.addEventListener('change', toggleFormFields);
        
        spendableIncomeTargetInput.addEventListener('change', (e) => {
            const newTarget = parseFloat(e.target.value);
            if (!isNaN(newTarget) && newTarget >= 0) {
                appData.settings.spendableIncomeTarget = newTarget;
                saveData();
                updateSummary();
                 showMessage('Spendable income target updated.', 'success');
            } else {
                e.target.value = appData.settings.spendableIncomeTarget.toFixed(2); // Revert if invalid
                showMessage('Invalid target amount.', 'error');
            }
        });

        filterTypeSelect.addEventListener('change', renderTransactions);
        filterCategorySelect.addEventListener('change', renderTransactions);


        // --- INITIAL LOAD ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            toggleFormFields(); // Set initial form field visibility
            populatePaymentSources(); // Also populates filter categories via populateCategories
            document.getElementById('transactionDate').valueAsDate = new Date(); // Default date to today
            renderTransactions(); // Initial render
            document.getElementById('currentYear').textContent = new Date().getFullYear();

            // Debounce chart rendering on resize
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    renderExpenseChart();
                }, 250);
            });
        });

    </script>
</body>
</html>
